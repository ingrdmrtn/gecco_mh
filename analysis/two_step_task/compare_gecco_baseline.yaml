compare:
  psychiatry: true
  hybrid_model: |
    def hybrid_model(action_1, state, action_2, reward, model_parameters):
      """
      Hybrid Model-Based and Model-Free Learning with Perseveration and Eligibility Traces.

      Parameters:
          - learning_rate: Learning rate for stage 1 MF updates
          - learning_rate_2: Learning rate for stage 2 MF updates
          - beta: Inverse temperature for stage 1 choices
          - beta_2: Inverse temperature for stage 2 choices
          - w: Weight on model-based vs. model-free values(stage 1)
          - lambd: Eligibility trace weight
          - perseveration: Tendency to repeat previous stage 1 action
      """

      # Unpack parameters
      learning_rate, learning_rate_2, beta, beta_2, w, lambd, perseveration = model_parameters
      n_trials = len(action_1)

      # Transition model: spaceship -> planet
      transition_matrix = np.array([[0.7, 0.3], [0.3, 0.7]])

      # Perseveration indicator: 1 if action was repeated at stage 1
      prev_action_indicator = np.zeros(2)

      # Store choice probabilities
      p_choice_1 = np.zeros(n_trials)
      p_choice_2 = np.zeros(n_trials)

      # Initialize Q-values
      q_stage1_mf = np.zeros(2)          # Model-free Q-values for spaceship choices
      q_stage2_mf = np.zeros((2, 2))     # Model-free Q-values for state × action

      for trial in range(n_trials):
          # ----- Stage 1 -----
          max_q_stage2 = np.max(q_stage2_mf, axis=1)  # max Q for each planet
          q_stage1_mb = transition_matrix @ max_q_stage2  # model-based Q-values

          q_stage1_combined = w * q_stage1_mb + (1 - w) * q_stage1_mf
          q_stage1_with_pers = q_stage1_combined + perseveration * prev_action_indicator

          exp_q1 = np.exp(beta * q_stage1_with_pers)
          probs_1 = exp_q1 / np.sum(exp_q1)
          p_choice_1[trial] = probs_1[action_1[trial]]

          # ----- Stage 2 -----
          state_idx = state[trial]
          exp_q2 = np.exp(beta_2 * q_stage2_mf[state_idx])
          probs_2 = exp_q2 / np.sum(exp_q2)
          p_choice_2[trial] = probs_2[action_2[trial]]

          # ----- Learning -----

          # TD error for stage 1 (bootstrapped from stage 2)
          delta_stage1 = q_stage2_mf[state_idx, action_2[trial]] - q_stage1_mf[action_1[trial]]
          q_stage1_mf[action_1[trial]] += learning_rate * delta_stage1

          # TD error for stage 2
          delta_stage2 = reward[trial] - q_stage2_mf[state_idx, action_2[trial]]
          q_stage2_mf[state_idx, action_2[trial]] += learning_rate_2 * delta_stage2

          # Eligibility trace for stage 1
          q_stage1_mf[action_1[trial]] += lambd * learning_rate * delta_stage2

          # ----- Perseveration update -----
          prev_action_indicator.fill(0)
          prev_action_indicator[action_1[trial]] = 1

      eps = 1e-10
      log_loss = -(np.sum(np.log(p_choice_1 + eps)) + np.sum(np.log(p_choice_2 + eps)))

      return log_loss

  comparison_prompt: |
    ## Instructions
    Compare the base hybrid model with the participant-specific cognitive model we have generated to explain human behavior in two-step decision task . 
    Look for patterns between the two models and extract components in the participant-specific cognitive model that are shared with the base model and those that are not.
    There are cases where the hybrid model under some parameter settings (e.g. parameter values) can express the same mechanism as in the participant specific model. These are considered shared mechanisms.
    Alternatively, there are cases where participant-specific model introduces a new mechanism that is not part of the hybrid model, and under no parameter settings is able to express the same mechansim.

    ## Task Structure of two-step decision making task
    - Stage 1: Binary choice → transition to state
    - Stage 2: Binary choice in state → reward (0/1)
    {psychiatry}
    - Transition matrix: T = [[0.7, 0.3], [0.3, 0.7]]

    ## Base hybrid model
    {base_code}

    ## Participant-specific model
    {model_code}

    ## Guardrails
    - Do not focus on trivial changes such as parameter names. The docstring for the models provides the fair idea of what the parameter is doing, if not, the code should give you the clear idea.
    - Shared parameters should be named exactly same as parameter names in the hybrid model: learning rate, learning rate 2, beta, beta 2, w, lambda, perseveration if they are doing the same thing as in the base hybrid model.

    ## Output Format
    - Output should be parseable json with the following fields: 
        "model_type": string, # extract info from the docstring of the participant-specific model
        "shared": string, # "full" if all parameters in participant-specific model are shared with the base hybrid model, "none" if none are shared otherwise "partial"
        "shared_parameters": list([param1, param2,...]),
        "shared_mechanisms": list([mech1, mech2,...]), # Mechanisms should be described in hyphenated words (between two and three words); don't include model name as mechanism.
        "unique_parameters": list([param1, param2,...]),
        "unique_mechanisms": list([mech1, mech2,...]), # Mechanisms should be described in hyphenated words (between two and three words); don't include model name as mechanism.
        "participant_model_parameter_names": list([param1, param2,...]),
        "base_model_parameter_names": list([param1, param2,...])

    ## Definitions
    - model_type: short description of the participant-specific model taken from the docstring.
    - shared: string indicating whether the participant-specific model shares all parameters with the base hybrid model ("full", "none", or "partial").
    - shared_parameters: list of parameters in the participant-specific model that are also in the base hybrid model.
    - shared_mechanisms: list of mechanisms in the participant-specific model that are also in the base hybrid model.
    - unique_parameters: list of parameters in the participant-specific model that are not in the base hybrid model.
    - unique_mechanisms: list of mechanisms in the participant-specific model that are not in the base hybrid model.
    - participant_model_parameter_names: list of all the parameters in the participant-specific model.
    - base_model_parameter_names: list of all the parameters in the base hybrid model.
    
