class ParticipantModel2(CognitiveModelBase):
    """
    HYPOTHESIS: Anxiety-Modulated Perseveration/Switching at Stage 1
    This model suggests that high anxiety affects the participant's tendency to
    either perseverate (stick with) or switch from their previously chosen
    first-stage action. A 'perseveration bonus' (or penalty if negative) is
    added to the Q-value of the action chosen on the immediately preceding trial
    at Stage 1, before the softmax decision. This bonus/penalty is modulated by
    the STAI score, allowing anxiety to either increase perseveration or encourage switching.

    Parameter Bounds:
    -----------------
    alpha: [0, 1] (Learning rate for Q-values)
    beta: [0, 10] (Inverse temperature for softmax choice)
    k_base: [-2, 2] (Base perseveration bonus; positive for perseveration, negative for switching)
    stai_k_effect: [-2, 2] (How much STAI score modulates the perseveration bonus)
    """

    def unpack_parameters(self, model_parameters: tuple) -> None:
        self.alpha, self.beta, self.k_base, self.stai_k_effect = model_parameters
        # Calculate the effective perseveration bonus, modulated by STAI
        self.perseveration_bonus = self.k_base + self.stai_k_effect * self.stai

    def policy_stage1(self) -> np.ndarray:
        """
        Compute stage-1 action probabilities, incorporating a perseveration bonus
        if a previous action exists.
        """
        q_values_with_perseveration = np.copy(self.q_stage1)
        if self.last_action1 is not None:
            # Add bonus to the last chosen action's Q-value
            q_values_with_perseveration[self.last_action1] += self.perseveration_bonus
        
        return self.softmax(q_values_with_perseveration, self.beta)

cognitive_model2 = make_cognitive_model(ParticipantModel2)