class ParticipantModel3(CognitiveModelBase):
    """
    HYPOTHESIS: Anxiety influences the participant's choice policy directly. 
    It creates a conflict between two tendencies: 
    1. Perseveration: An increased tendency to repeat the previous choice, 
       modeled by a 'stickiness' parameter 'p' that is amplified by STAI.
    2. Randomness: A decrease in choice consistency (lower beta), making choices 
       more exploratory or erratic, also modulated by STAI.
    This model captures how anxiety might simultaneously promote rigid habits 
    and uncertain exploration.

    Parameter Bounds:
    -----------------
    alpha: [0, 1]    (Learning rate)
    beta: [0, 10]   (Base inverse temperature for choice consistency)
    p: [0, 5]       (Base perseveration/stickiness weight)
    """
    
    def unpack_parameters(self, model_parameters: tuple) -> None:
        self.alpha, self.beta, self.p = model_parameters

    def pre_trial(self) -> None:
        """
        Before each trial, set up the perseveration bonus for the last action.
        """
        self.perseveration_bonus = np.zeros(self.n_choices)
        if self.last_action1 is not None:
            self.perseveration_bonus[self.last_action1] = 1.0

    def policy_stage1(self) -> np.ndarray:
        """
        Computes stage-1 policy using Q-values augmented by an anxiety-driven
        perseveration bonus, and with an anxiety-reduced choice consistency.
        """
        # Anxiety increases perseveration strength
        effective_p = self.p * self.stai
        
        # Anxiety decreases choice consistency (inverse temperature)
        effective_beta = self.beta * (1 - self.stai)
        
        # Add perseveration bonus to the learned Q-values
        q_values_with_perseveration = self.q_stage1 + effective_p * self.perseveration_bonus
        
        return self.softmax(q_values_with_perseveration, max(0, effective_beta))

cognitive_model3 = make_cognitive_model(ParticipantModel3)