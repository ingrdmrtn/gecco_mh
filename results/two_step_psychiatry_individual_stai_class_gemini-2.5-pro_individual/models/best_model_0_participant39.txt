class ParticipantModel3(CognitiveModelBase):
    """
    HYPOTHESIS: High anxiety impairs the integration of surprising information,
    specifically by suppressing learning following rare state transitions.
    This prevents the participant from building a correct model of the task,
    fostering a reliance on simple, model-free habits. The degree of learning
    suppression after a rare transition is scaled by the participant's anxiety (stai).

    Parameter Bounds:
    -----------------
    alpha: [0, 1]        (Base learning rate)
    beta: [0, 10]        (Inverse temperature for choice stochasticity)
    suppression: [0, 1]  (Strength of learning suppression after rare transitions)
    """

    def unpack_parameters(self, model_parameters: tuple) -> None:
        self.alpha, self.beta, self.suppression = model_parameters

    def value_update(self, action_1: int, state: int, action_2: int, reward: float) -> None:
        """
        Updates Q-values with a learning rate that is suppressed if the
        transition from stage 1 to stage 2 was a 'rare' one.
        """
        # A transition is 'common' if the action index matches the state index
        # (e.g., action 0 -> state 0; action 1 -> state 1)
        is_common_transition = (action_1 == state)
        
        alpha_effective = self.alpha
        
        if not is_common_transition:
            # If the transition was rare, suppress the learning rate
            suppression_factor = self.suppression * self.stai
            alpha_effective *= (1.0 - min(suppression_factor, 1.0))
            
        # Perform TD updates with the effective learning rate
        delta_2 = reward - self.q_stage2[state, action_2]
        self.q_stage2[state, action_2] += alpha_effective * delta_2
        
        delta_1 = self.q_stage2[state, action_2] - self.q_stage1[action_1]
        self.q_stage1[action_1] += alpha_effective * delta_1

cognitive_model3 = make_cognitive_model(ParticipantModel3)