class ParticipantModel3(CognitiveModelBase):
    """
    HYPOTHESIS: This model suggests a "Surprise-Resistant Perseverator".
    The participant has a general tendency to repeat choices (perseveration).
    Crucially, their low anxiety makes them less reactive to surprising outcomes.
    When a rare transition occurs, they update their first-stage choice values
    less, effectively ignoring information that strongly violates their expectations.

    Parameter Bounds:
    -----------------
    alpha: [0, 1]      (Base learning rate)
    beta: [0, 10]      (Inverse temperature)
    p: [0, 5]          (Perseverance strength bonus)
    """

    def unpack_parameters(self, model_parameters: tuple) -> None:
        self.alpha, self.beta, self.p = model_parameters

    def policy_stage1(self) -> np.ndarray:
        """
        Stage-1 policy includes a perseverance bonus for the last-chosen action.
        """
        q_policy = np.copy(self.q_stage1)
        if self.last_action1 is not None:
            q_policy[self.last_action1] += self.p
        return self.softmax(q_policy, self.beta)

    def value_update(self, action_1: int, state: int, action_2: int, reward: float) -> None:
        """
        The first-stage learning rate is reduced on rare transition trials,
        scaled by the participant's low anxiety.
        """
        # Determine if the transition was common (action_1 == state) or rare
        is_rare_transition = (action_1 != state)
        
        # Low anxiety reduces learning from surprising (rare) events
        # Effective alpha is self.alpha on common trials, but reduced on rare trials
        alpha_stage1 = self.alpha * (1 - self.stai) if is_rare_transition else self.alpha
        
        # Standard TD updates
        delta_2 = reward - self.q_stage2[state, action_2]
        self.q_stage2[state, action_2] += self.alpha * delta_2
        
        delta_1 = np.max(self.q_stage2[state, :]) - self.q_stage1[action_1]
        self.q_stage1[action_1] += alpha_stage1 * delta_1

cognitive_model3 = make_cognitive_model(ParticipantModel3)