class ParticipantModel1(CognitiveModelBase):
    """
    HYPOTHESIS: Anxiety-Modulated Hybrid Model (MB/MF).
    
    This model assumes the participant uses a mixture of Model-Based (MB) and 
    Model-Free (MF) strategies. The core hypothesis is that anxiety consumes 
    cognitive resources, reducing the weight of the computationally expensive 
    Model-Based system.
    
    The mixing weight 'w' determines the balance: Q_net = w * Q_MB + (1-w) * Q_MF.
    The effective weight is modulated by STAI: w_eff = w_max * (1 - stai).
    Higher anxiety (STAI) leads to a lower contribution of the Model-Based system.
    
    The model also includes a perseveration parameter to account for the observed stickiness.

    Parameter Bounds:
    -----------------
    alpha: [0, 1]        - Learning rate for MF values
    beta: [0, 10]        - Inverse temperature for softmax
    w_max: [0, 1]        - Maximum Model-Based weight (at 0 anxiety)
    perseveration: [0, 5]- Stickiness to previous choice
    """

    def unpack_parameters(self, model_parameters: tuple) -> None:
        self.alpha, self.beta, self.w_max, self.perseveration = model_parameters

    def policy_stage1(self) -> np.ndarray:
        # 1. Calculate Model-Based Values
        # V(State) = max(Q_stage2(State, :))
        v_stage2 = np.max(self.q_stage2, axis=1) 
        # Q_MB = Transition_Matrix * V_stage2
        q_mb = self.T @ v_stage2
        
        # 2. Calculate Mixing Weight based on Anxiety
        # Higher STAI -> Lower w_eff -> More Model-Free behavior
        w_eff = self.w_max * (1.0 - self.stai)
        w_eff = np.clip(w_eff, 0, 1)
        
        # 3. Combine MB and MF values (self.q_stage1 is the MF value)
        q_net = w_eff * q_mb + (1 - w_eff) * self.q_stage1
        
        # 4. Add Perseveration
        if self.last_action1 is not None:
            q_net[self.last_action1] += self.perseveration
            
        return self.softmax(q_net, self.beta)

cognitive_model1 = make_cognitive_model(ParticipantModel1)