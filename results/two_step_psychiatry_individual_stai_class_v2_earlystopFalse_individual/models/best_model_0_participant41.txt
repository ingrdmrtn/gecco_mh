class ParticipantModel3(CognitiveModelBase):
    """
    Hypothesis: Anxiety modulates choice perseveration (stickiness).
    A 'stickiness' bonus is added to the Q-value of the action taken in the previous trial.
    
    The magnitude of this bonus is determined by a base parameter and STAI:
    stickiness = phi * (1 + stai)
    
    If phi is positive, anxiety increases repetition (safety behavior).
    If phi is negative, anxiety increases switching (restlessness).
    
    Parameter Bounds:
    -----------------
    alpha: [0, 1]   # Learning rate
    beta: [0, 10]   # Inverse temperature
    phi: [-2, 2]    # Base perseveration parameter
    """

    def unpack_parameters(self, model_parameters: tuple) -> None:
        self.alpha, self.beta, self.phi = model_parameters

    def policy_stage1(self) -> np.ndarray:
        # Calculate effective stickiness
        stickiness_bonus = self.phi * (1.0 + self.stai)
        
        # Copy Q-values to avoid modifying the learned values permanently
        q_vals = self.q_stage1.copy()
        
        # Add bonus to the previously chosen action (if one exists)
        if self.last_action1 is not None:
            q_vals[int(self.last_action1)] += stickiness_bonus
            
        return self.softmax(q_vals, self.beta)

    def policy_stage2(self, state: int) -> np.ndarray:
        # We apply stickiness to stage 2 as well, specific to the state
        # Note: We only track last_action2 generally, but strictly speaking, 
        # perseveration usually applies to the specific state-action pair.
        # For simplicity, we apply it if the last trial visited this same state.
        
        q_vals = self.q_stage2[state].copy()
        
        stickiness_bonus = self.phi * (1.0 + self.stai)
        
        if self.last_state is not None and self.last_state == state and self.last_action2 is not None:
            q_vals[int(self.last_action2)] += stickiness_bonus
            
        return self.softmax(q_vals, self.beta)

cognitive_model3 = make_cognitive_model(ParticipantModel3)